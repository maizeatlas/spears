# This takes output from SAEGUS and formats for MACH based on missingness data and founder genotypes
# Requires sim output from SAEGUS and founder key data (see file formats in README)

# Required Packages
library("tidyr")
library("gdata")
library("data.table")

# User inputs
# Working directory
wd <- "~/working/directory/"
# Simulated GT matrix
sd <- "simdata_n1000_test_set_GTform_vcf.csv"
#Simulated Parent_of_origin
ld <- "simdata_n1000_parent_of_origin.csv"
# Name of founder key data
fd <- "founder_key_vcf.txt"
# Number of chromosomes
chrom <- 10
# Name of Population (for MACH output)
popID <- "Pop"
# Sample number
sn <- 100
#Rsq Threshold (for imputation output)
rsq <- 0.8
#Genotyping Error
g_error <- 0.006

# Set working directory, which contains the simulated output from SAEGUS and the founder key data
setwd(wd)

#write file that contains all user inputs for downstream scripts to use
write.table(rbind(wd,sd,ld,fd,chrom,popID,sn,rsq),"user_input.txt", col.names = F, sep="\t")


# Founder Data
founders <- read.table(fd, head=T, stringsAsFactors = FALSE,sep='\t') #Founder data key for GT info and marker info
founders <- rename.vars(founders,"chr","CHROM") #Rename because SAEGUS uses "chr" as the variable name

# SimuPop Output
sim <- read.csv(sd,head=T, stringsAsFactors = FALSE) #Reads in GT output from 1_SAEGUS.py

#Collapse alleles into Genotypes and transpose for MACH
out <- sim[1]
out[2:(((ncol(sim)-1)/2)+1)] <- lapply(seq(2, ncol(sim), 2), 
                                  function(i) do.call(paste0, c(sim[i],"/",sim[(i+1)])))
sim <- as.data.frame(t(out[2:ncol(out)]))
#Rename samples to sim.sample#
names(sim) <- paste("sim.sample",out$ind_id,sep="")
#Concatenate snpID, CHROM, POS, cM, and F_MISS data from founder key
sim <- cbind(founders[,1:7],sim)
known <- sim

#Genotyping error
#1 Create a dataframe (num_loci x num_indv) filled with random sampling from uniform distribution
err_df <- as.data.frame(matrix(runif(nrow(founders)*sn),nrow(founders),sn))
#2 sample GTs and change
#index positions in err_df < user defined ERR at that locus
gt_change <- which(err_df<g_error, arr.ind = T)
#locate indexed positions in simdata and randomly change to one of two remaining GTs (equal prob)
sim[,8:ncol(sim)][gt_change] <- ifelse(sim[,8:ncol(sim)][gt_change]=="0/0", sample(c("0/1","1/1"),1), ifelse(sim[,8:ncol(sim)][gt_change]=="1/1", sample(c("0/0","0/1"),1), sample(c("0/0","1/1"))))


#Calculate realized error at each locus
err_df$R_ERR <- apply(err_df,1,function(x) length(which(x<g_error))/sn)
#Histogram of realized error
hist(err_df$R_ERR, main = "Realized Genotyping Error Across all Loci", xlab = "Realized GT Error")
#Append realized error distribution to known GT data set
known <- cbind.data.frame(known[,1:5],R_ERR = err_df[,(sn+1)], known[,6:ncol(known)])

#Output known GT data for later
write.csv(known,"known_GT_simdata_vcf.csv",row.names = F)
write.table(cbind("kd","known_GT_simdata_vcf.csv"),"user_input.txt", col.names = F, sep="\t", append = TRUE, row.names = F)


#Induce missing data 
sim$F_MISS_r <- (round(sim$F_MISS,(nchar(sn)-1))*sn) #Create an integer for number of genotypes to set to missing (rounded to whole number based on original sample number)
sim <- subset(sim,sim$F_MISS_r<sn) #Remove markers with completely missing data, will be imputed back in later by MACH (also reduces time to run for next step)

#Randomly pick n number of samples based on the rounded missing proportion for each marker and set to missing
look <- split(as.matrix(sim[,8:(ncol(sim))]), row(as.matrix(sim[,8:(ncol(sim))])))
for (i in 1:nrow(sim)){
  
  look[[i]][sample(sn,look[[i]][sn+1])] <- "./."
  
}
look <- as.data.frame(do.call("rbind",look))
names <- (colnames(sim[1:ncol(sim)-1]))
sim <- cbind(sim[,1:7],look[,1:sn])
colnames(sim) <- names

#Format alleles in required format for MACH (A,C,T,G) for founders and population
#Founders
look <- split(as.matrix(founders[,6:(ncol(founders))]), row(as.matrix(founders[,6:(ncol(founders))])))
for (i in 1:nrow(founders)){
  #founders[i,8:ncol(founders)] <- gsub("0/0", (paste0(as.character(founders$REF[i]), "/", as.character(founders$REF[i]))), founders[i,8:ncol(founders)])
  #founders[i,8:ncol(founders)] <- gsub("1/1", (paste0(as.character(founders$ALT[i]), "/", as.character(founders$ALT[i]))), founders[i,8:ncol(founders)])
  look[[i]] <- gsub("0/0", (paste0(as.character(look[[i]][1]), "/", as.character(look[[i]][1]))), look[[i]])
  look[[i]] <- gsub("1/1", (paste0(as.character(look[[i]][2]), "/", as.character(look[[i]][2]))), look[[i]])
}
look <- as.data.frame(do.call("rbind",look))
names <- colnames(founders)
founders <- cbind(founders[,1:5],look)
colnames(founders) <- names

#Population
start_time <- Sys.time()
look <- split(as.matrix(sim[,6:(ncol(sim))]), row(as.matrix(sim[,6:(ncol(sim))])))
for (i in 1:nrow(sim)){
  #sim[i,9:ncol(sim)] <- gsub("0/0", (paste0(as.character(sim$REF[i]), "/", as.character(sim$REF[i]))), sim[i,9:ncol(sim)])
  #sim[i,9:ncol(sim)] <- gsub("1/1", (paste0(as.character(sim$ALT[i]), "/", as.character(sim$ALT[i]))), sim[i,9:ncol(sim)])
  #sim[i,9:ncol(sim)] <- gsub("0/1", (paste0(as.character(sim$REF[i]), "/", as.character(sim$ALT[i]))), sim[i,9:ncol(sim)])
  #sim[i,9:ncol(sim)] <- gsub("1/0", (paste0(as.character(sim$REF[i]), "/", as.character(sim$ALT[i]))), sim[i,9:ncol(sim)])
  look[[i]] <- gsub("0/0", (paste0(as.character(look[[i]][1]), "/", as.character(look[[i]][1]))), look[[i]])
  look[[i]] <- gsub("1/1", (paste0(as.character(look[[i]][2]), "/", as.character(look[[i]][2]))), look[[i]])
  look[[i]] <- gsub("0/1", (paste0(as.character(look[[i]][1]), "/", as.character(look[[i]][2]))), look[[i]])
  look[[i]] <- gsub("1/0", (paste0(as.character(look[[i]][1]), "/", as.character(look[[i]][2]))), look[[i]])
  
}
look <- as.data.frame(do.call("rbind",look))
names <- (colnames(sim))
sim <- cbind(sim[,1:5],look)
colnames(sim) <- names
end_time <- Sys.time()
end_time - start_time

### Create MACH data, based on required format for MACH, see MACH help page
# Create MACH directory and folder for each chromosome within working directory
dir.create("MACH")
setwd("./MACH") #navigate to directory
# Create directory for each chromosome
for (i in seq(1,chrom)){
  dir.create(paste0('chrom',i))
}

# Create founder_map, which lists chrom and pos of founder data, population.dat, which lists the overlapping markers between founders and population
founders_map <- founders[,1:3]
founders_map <- founders_map[order(as.numeric(founders_map$snpID)),]

# Subset all_data to keep snpID, Chrom, Pos, and samples
all_data2 <- sim[,-c(4:7)] #Removes cM, F_MISS, REF, ALT
founders_map[,1] <- sub("^","M SNP",founders_map[,1]) #Add "M_SNP" in front of marker ids in population (required format for MACH)
#This is the set of overlapping markers between the founder set and the population
population.dat <- founders_map[which(interaction(founders_map$CHROM, founders_map$POS) %in% 
                                       interaction(all_data2$CHROM,all_data2$POS)),1:2]

# Create .dat files for each chromosome from population.dat
for(i in seq(1,chrom)){
  setwd(paste0(wd,"/MACH/chrom",i))
  write.table(population.dat[population.dat$CHROM == i,][1], file = paste0("simdata_chrom_",i,".dat"), 
              quote = FALSE, sep = "\t", row.names = FALSE, col.names = FALSE)
}

# Create .PED file (genotype data on specific chromosome for population)
all_data2 <- all_data2[with(all_data2,order(as.numeric(snpID))),] #Make sure order of markers is maintained
for (i in seq(1,chrom)){
  population.ped <- as.data.frame(t(all_data2[all_data2$CHROM == i,][,-c(1:3)]))
  population.ped <- data.frame(fID=popID, iID=rownames(population.ped), pID=0, mID=0, sex=0, population.ped) #Required IDs for MACH
  setwd(paste0(wd,"/MACH/chrom",i))
  write.table(population.ped, file = paste0("simdata_chrom_",i,".PED"),
              quote = FALSE, sep = "\t", row.names = FALSE, col.names = FALSE)
}

# Create founders_chrom_X.snps file (list of founder SNP#'s on specfic chromosome)
for(i in seq(1,chrom)){
  founders.snps <- data.frame(snpID=substring(founders_map[founders_map$CHROM == i,][,1],3))
  setwd(paste0(wd,"/MACH/chrom",i))
  write.table(founders.snps, file = paste0("founders_chrom_",i,".snps"), quote = FALSE,
              sep = "\t", row.names = FALSE,col.names = FALSE)
}

# Create founders_chrom_X.haplos file (founder haplotype data on specific chromosome)
for(i in seq(1,chrom)){
  founders.chrom.haps <- as.data.frame(t(founders[founders$CHROM == i,c(-1:-7)])) #transpose data and remove snpID, CHROM, and POS columns
  
  rownames(founders.chrom.haps) <- paste0(' ',rownames(founders.chrom.haps),' (',c(1:length(8:ncol(founders))),')') #Set row names as founder IDs
  founders.chrom.haps <- as.data.frame(founders.chrom.haps[rep(1:nrow(founders.chrom.haps), each=2),]) #Creates two rows for each founder (each homolog)
  
  founders.chrom.haps <- data.frame("fID" = rownames(founders.chrom.haps),founders.chrom.haps, row.names = NULL)
  founders.chrom.haps <- cbind.data.frame('index' = rownames(founders.chrom.haps),
                                          "fID" =gsub('\\.1',"", founders.chrom.haps$fID),"HapID" = c("HAP1","HAP2"),
                                          founders.chrom.haps[2:ncol(founders.chrom.haps)]) #creates and formats dataframe
  
  # Removing the second allele from first haplotype and first allele from second haplotype
  founders.chrom.haps <- rbind.data.frame(lapply(founders.chrom.haps[c(TRUE,FALSE),], gsub, pattern='/[A-Z]', replacement=''),
                                          lapply(founders.chrom.haps[c(FALSE,TRUE),], gsub, pattern='[A-Z]/', replacement=''))
  # Reordering into correct order
  founders.chrom.haps <- founders.chrom.haps[order(as.numeric(founders.chrom.haps$index)),]
  setwd(paste0(wd,"/MACH/chrom",i))
  write.table(founders.chrom.haps[,-1],file = paste0('founders_chrom_',i,".haplos"),quote = FALSE, sep = '\t',
              row.names = FALSE,col.names = FALSE)
}
